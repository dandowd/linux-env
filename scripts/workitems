#!/bin/zsh

# workitems - Display current user's work items with better formatting and optional subtasks
# Shows work items from current sprints with status, summary, and optionally subtasks
# Usage: workitems [--status STATUS_NAME] [--subtasks|-s] [--web|-w WORK_ITEM_KEY]

# Parse command line arguments
TARGET_STATUS=""
SHOW_SUBTASKS=false
OPEN_WEB=false
WEB_WORK_ITEM=""
while [[ $# -gt 0 ]]; do
    case $1 in
        --status)
            TARGET_STATUS="$2"
            shift 2
            ;;
        --subtasks|-s)
            SHOW_SUBTASKS=true
            shift
            ;;
        --web|-w)
            OPEN_WEB=true
            WEB_WORK_ITEM="$2"
            shift 2
            ;;
        --help|-h)
            echo "Usage: workitems [--status STATUS_NAME] [--subtasks|-s] [--web|-w WORK_ITEM_KEY]"
            echo "  --status        Filter by specific status (e.g., 'In Progress', 'To Do')"
            echo "  --subtasks, -s  Include subtasks in the output"
            echo "  --web, -w       Open specific work item in web browser (e.g., --web AGINTEL-123)"
            echo "  --help, -h      Show this help message"
            exit 0
            ;;
        *)
            echo "Unknown option: $1"
            echo "Use --help for usage information"
            exit 1
            ;;
    esac
done

# If --web flag is used with a work item key, just open that item and exit
if [[ "$OPEN_WEB" == true && -n "$WEB_WORK_ITEM" ]]; then
    echo "ðŸŒ Opening $WEB_WORK_ITEM in browser..."
    
    # Get the Jira site URL from acli auth status
    JIRA_SITE=$(acli jira auth status 2>/dev/null | grep "Site:" | awk '{print $2}')
    
    if [[ -n "$JIRA_SITE" ]]; then
        BROWSE_URL="https://${JIRA_SITE}/browse/${WEB_WORK_ITEM}"
        open "$BROWSE_URL"
        echo "âœ… Opened $WEB_WORK_ITEM in browser: $BROWSE_URL"
    else
        echo "âŒ Error: Could not get Jira site URL from acli auth status"
        echo "ðŸ’¡ Try running: acli jira auth status"
        exit 1
    fi
    exit 0
fi

# Build JQL query
JQL_QUERY="project = AGINTEL AND assignee = currentUser() AND sprint in openSprints()"
if [[ -n "$TARGET_STATUS" ]]; then
    JQL_QUERY="$JQL_QUERY AND status = \"$TARGET_STATUS\""
    echo "ðŸŽ¯ Current Sprint Work Items (Status: $TARGET_STATUS)"
else
    echo "ðŸŽ¯ Current Sprint Work Items"
fi
echo "=" | tr '=' '=' | head -c 50; echo

# Get main work items
WORK_ITEMS=$(acli jira workitem search --jql "$JQL_QUERY" --json)

if [[ $? -ne 0 ]]; then
    echo "âŒ Error: Could not retrieve work items"
    exit 1
fi

# Check if we have any work items
ITEM_COUNT=$(echo "$WORK_ITEMS" | jq 'length')
if [[ $ITEM_COUNT -eq 0 ]]; then
    echo "ðŸ“­ No work items found in current sprints"
    exit 0
fi

# Process each work item - simplified and faster
echo "$WORK_ITEMS" | jq -r '.[] | .key' | while read -r WORK_ITEM_KEY; do
    # Display main work item info directly from search results
    echo "$WORK_ITEMS" | jq -r --arg key "$WORK_ITEM_KEY" '
    .[] | select(.key == $key) |
    "ðŸ“‹ \(.key) - \(.fields.status.name)
       \(.fields.summary)
       Priority: \(.fields.priority.name // "None")
       Type: \(.fields.issuetype.name)"
    '
    

    
    # Get subtasks for this work item (only if --subtasks flag is set)
    if [[ "$SHOW_SUBTASKS" == true ]]; then
        SUBTASKS=$(acli jira workitem search --jql "parent = $WORK_ITEM_KEY" --json 2>/dev/null)
        
        if [[ $? -eq 0 ]] && [[ $(echo "$SUBTASKS" | jq 'length') -gt 0 ]]; then
            SUBTASK_COUNT=$(echo "$SUBTASKS" | jq 'length')
            echo "   Subtasks ($SUBTASK_COUNT):"
            echo "$SUBTASKS" | jq -r '.[] | "      â€¢ \(.key) - \(.fields.status.name): \(.fields.summary)"'
            

        else
            echo "   No subtasks"
        fi
    fi
    echo
done

echo "ðŸ“Š Summary: $ITEM_COUNT work item(s) found"
